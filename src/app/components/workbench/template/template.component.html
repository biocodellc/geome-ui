
<section class="Mekong">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <h3 class="mek-hed1">{{ currentProject?.projectTitle }}</h3>
                <p class="mek-hed1">{{ currentProject?.description }}</p>
                <form class="form-horizontal">
                    <div class="row mb-3">
                        <div class="col-sm-6">
                            <button type="button" class="btn btn-primary float-end" (click)="generate()"><i class="fas fa-file-excel me-1"></i>Export Excel</button>
                        </div>
                    </div>

                    <div class="mb-3 row">
                        <div class="col-12 d-flex justify-content-center align-items-center template-toolbar">
                            <label class="template-toolbar-label">Template:</label>
                            <div class="d-flex gap-2 align-items-center template-config-actions">
                            <select class="form-control temp-dropdown" name="templates" [(ngModel)]="selectedTemplate" (change)="onTemplateChange()">
                                <option value="">DEFAULT</option>
                                @for(template of filteredTemplates; track template){
                                    <option [value]="template">{{template}}</option>
                                }
                            </select>
                            @if(selectedTemplate){
                                <button
                                    type="button"
                                    class="template-info-icon"
                                    aria-label="Template owner details"
                                    [ngbPopover]="selectedTemplateInfoText"
                                    popoverTitle="Template Details"
                                    placement="right"
                                    triggers="click"
                                    autoClose="outside">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            }
                            @if(selectedTemplate){
                                <button type="button" class="btn btn-outline-success btn-sm template-action-btn" [class.login-required-btn]="!isLoggedIn || !canManageSelectedTemplate" (click)="updateSelectedTemplate()"><i class="fas fa-save"></i><span>Save</span></button>
                            }
                            <button type="button" class="btn btn-outline-secondary btn-sm template-action-btn" [class.login-required-btn]="!isLoggedIn || (selectedTemplate && !canManageSelectedTemplate)" [disabled]="!selectedTemplate" (click)="openRenameModal(save_template_modal)"><i class="fas fa-pen"></i><span>Rename</span></button>
                            <button type="button" class="btn btn-outline-danger btn-sm template-action-btn" [class.login-required-btn]="!isLoggedIn || (selectedTemplate && !canManageSelectedTemplate)" [disabled]="!selectedTemplate" (click)="deleteSelectedTemplate()"><i class="fas fa-trash"></i><span>Delete</span></button>
                            <button type="button" class="btn btn-outline-primary btn-sm template-action-btn" [class.login-required-btn]="!isLoggedIn" (click)="openCreateModal(save_template_modal)"><i class="fas fa-plus"></i><span>Create New</span></button>
                        </div>
                    </div>
                    </div>
                    <div class="mb-2 row justify-content-center">
                        <div class="col-12 d-flex justify-content-center">
                            <p class="mb-0 text-muted">{{selectedPropertyCount}} data properties selected in this template</p>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="save-temp">
            <div class="row">
                <div class="col-lg-6">
                    <div class="accordion-section" ngbAccordion [closeOthers]="false">
                        @if(selectedWorksheet == 'Workbook'){
                            <div class="form-check form-switch mt-3">
                                <input class="form-check-input" type="checkbox" role="switch" (change)="toggleSelectAll($event)">
                                <p class="include-prop">Include all properties</p>
                            </div>
                        }
                        @for(item of attributeArray; track item){
                            @if( selectedWorksheet == 'Workbook' || selectedWorksheet == item.worksheet){
                                <div ngbAccordionItem [collapsed]="true" #entitySection="ngbAccordionItem">
                                    <h2 ngbAccordionHeader>
                                        <button ngbAccordionButton class="entity-accordion-btn">
                                            <span>{{item.worksheet}}</span>
                                            <i class="fas" [ngClass]="entitySection.collapsed ? 'fa-chevron-right' : 'fa-chevron-down'"></i>
                                        </button>
                                    </h2>
                                    <div ngbAccordionCollapse>
                                        <div ngbAccordionBody>
                                            <ng-template>
                                                <div class="form-check form-switch mt-3">
                                                    <input class="form-check-input" type="checkbox" role="switch" (change)="toggleSelect($event, item.worksheet)">
                                                    <p class="include-prop">Include properties for all {{item.worksheet}}</p>
                                                </div>
                                                <div ngbAccordion [closeOthers]="false">
                                                    @for(attribute of Object.keys(item.data.attributes); track attribute){
                                                        <div ngbAccordionItem [collapsed]="false" #attributeSection="ngbAccordionItem">
                                                            <h2 ngbAccordionHeader>
                                                                <button ngbAccordionButton class="attribute-accordion-btn">
                                                                    <span>{{attribute}}</span>
                                                                    <i class="fas" [ngClass]="attributeSection.collapsed ? 'fa-chevron-right' : 'fa-chevron-down'"></i>
                                                                </button>
                                                            </h2>
                                                            <div ngbAccordionCollapse>
                                                                <div ngbAccordionBody>
                                                                    <ng-template>
                                                                        <div class="panel-body">
                                                                            @for(entity of item.data.attributes[attribute]; track entity){
                                                                                <div class="checkbox-sec">
                                                                                    <label>
                                                                                        <input
                                                                                            type="checkbox"
                                                                                            (change)="inputChange($event, entity, item.worksheet)"
                                                                                            [disabled]="attribute == 'Minimum Information Standard Items'"
                                                                                            [checked]="attribute == 'Minimum Information Standard Items' || selectedColumns(item.worksheet).includes(entity.column)">
                                                                                        {{entity.column}}
                                                                                    </label>
                                                                                    <a class="popover-button ms-2 cursor-pointer" (click)="openDef(entity, item.worksheet)">DEF</a>
                                                                                </div>
                                                                            }
                                                                        </div>
                                                                    </ng-template>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            </ng-template>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        <!-- <div ngbAccordionItem>
                            <h2 ngbAccordionHeader>
                                <button ngbAccordionButton>Taxonomy and Life History</button>
                            </h2>
                            <div ngbAccordionCollapse>
                                <div ngbAccordionBody>
                                    <ng-template>
                                        Anim pariatur cliche reprehenderit, enim eiusmod high life accusamus terry
                                        richardson ad squid. 3 wolf moon
                                        officia aute, non cupidatat skateboard dolor brunch. Food truck quinoa nesciunt
                                        laborum eiusmod. Brunch 3 wolf
                                        moon tempor, sunt aliqua put a bird on it squid single-origin coffee nulla
                                        assumenda shoreditch et. Nihil anim
                                        keffiyeh helvetica, craft beer labore wes anderson cred nesciunt sapiente ea
                                        proident. Ad vegan excepteur
                                        butcher vice lomo. Leggings occaecat craft beer farm-to-table, raw denim
                                        aesthetic synth nesciunt you probably
                                        haven't heard of them accusamus labore sustainable VHS.
                                    </ng-template>
                                </div>
                            </div>
                        </div> -->
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="def-panel-sticky">
                        <div class="save-right">
                            <h3 class="defin">Definition</h3>
                            <p class="click-def">Click on "DEF" next to any of the headings to see the definition of the
                                term.</p>
                        </div>
                        @if(currentStats){
                            <div class="mt-3">
                                <p class="mb-2"><span class="fw-semibold me-2">Column Name:</span>{{currentStats.column}}</p>
                                <p class="mb-2"><span class="fw-semibold me-2">Defined By:</span><a href="{{currentStats.definedBy}}" target="_blank">{{currentStats.definedBy}}</a></p>
                                <p class="mb-2"><span class="fw-semibold me-2">Data Type:</span>{{currentStats.dataType}}</p>
                                <p class="mb-2"><span class="fw-semibold me-2">Definition</span><br>{{currentStats.definition}}</p>
                            </div>
                            @if(currentStats.errors.length > 0){ <h5 class="mt-3">Validation Rules</h5> }
                            @for(error of currentStats.errors; track error){
                                <div class="mt-3">
                                    <p class="mb-2"><span class="fw-semibold me-2">Type:</span>{{error.name}}</p>
                                    <p class="mb-2"><span class="fw-semibold me-2">Level:</span>{{error.level}}</p>
                                    <p class="mb-2"><span class="fw-semibold me-2">Entity:</span>{{currentStats.entity}}</p>
                                </div>
                            }
                            @if(currentStats.list.length > 0){ <p class="fw-semibold mb-2">list:</p> }
                            <ul>
                                @for(item of currentStats.list; track item){ <li>{{item.value}}</li> }
                            </ul>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<ng-template #save_template_modal let-modal>
    <div class="modal-header border-0 justify-content-center">
		<h5 class="modal-title fw-semibold" id="modal-basic-title">{{templateModalMode === 'rename' ? 'Rename template' : 'What would you like to name your template?'}}</h5>
	</div>
	<div class="modal-body p-2 px-4 border-0" id="expedition_modal">
        <form [formGroup]="templateForm">
            <div class="mb-3">
                <div class="form-floating mb-1">
                    <input type="text" formControlName="templateName" class="form-control" id="floatingtemplateName" placeholder="templateName">
                    <label for="floatingtemplateName" class="ps-0 fw-semibold">{{templateModalMode === 'rename' ? 'New Template Name *' : 'Template Name *'}}</label>
                </div>
                @if(form['templateName'].touched && form['templateName'].invalid){
                    <span class="warn-text f-12">{{ form['templateName'].hasError('required') ? 'templateName is required.' : '' }}</span>
                }
            </div>
        </form>
    </div>
    <div class="modal-footer border-0 pt-0">
		<div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-outline-secondary" (click)="modal.close()">Cancel</button>
            <button type="button" class="btn btn-primary" (click)="templateModalMode === 'rename' ? renameTemplate() : saveTemplate()" [disabled]="templateForm.invalid || (templateModalMode === 'rename' ? !canManageSelectedTemplate : !canCreateTemplate)">{{templateModalMode === 'rename' ? 'Rename' : 'Save'}}</button>
        </div>
	</div>
</ng-template>
